!function(a){function b(){c(),d(),e(),f()}function c(){var b=[];a("[plan_id]").each(function(){var c=a(this).attr("plan_id");b.push(c)}),localStorage.plansOrder=JSON.stringify(b)}function d(){var b=[];g.each(function(){var c=a(this).attr("plan_id");1!=a(this).css("opacity")&&b.push(c)}),localStorage.plansOpacity=JSON.stringify(b)}function e(){if(i){var b=[];a(".plansGroupWrapper.folded").each(function(){var c=a(this).attr("data-object-id");b.push(c)}),localStorage.foldedGroups=JSON.stringify(b)}}function f(){var b=[];i&&(a(".plansGroupWrapper").each(function(){var c=a(this).attr("data-object-id");b.push(c)}),localStorage.groupsOrder=JSON.stringify(b))}if(a("#content").length){var g=a("[plan_id]"),h=.4,i=1==localStorage.groupPlans||!1;if(g.append("<div class='plan-icons'><div class='plan-icon plan-changeOpacity'></div><div class='plan-icon plan-moveHandle'></div></div>").wrapAll("<div class='plansGeneralWrapper'></div>"),a(".plan-changeOpacity").on("click",function(){var c=a(this).closest("[plan_id]");1==c.css("opacity")?c.css("opacity",h):c.css("opacity",1),b()}),a.fn.customSortable=function(){a(this).sortable({items:"[plan_id]",axis:"y",tolerance:"pointer",handle:".plan-moveHandle",stop:b})},a(".plansGeneralWrapper").before("<div class='plansGroupMode'><label><input id='plansSortToggle' type='checkbox'"+(i?" checked":"")+"> группировать по сайтам</label></div>"),a("#plansSortToggle").change(function(){localStorage.groupPlans=i?0:1,window.location.reload()}),i){var j={},k=JSON.parse(localStorage.groupsOrder);if(g.each(function(){var b=a(this).attr("object_id");j[b]?j[b].number++:(j[b]={},j[b].domain=a(this).find(".site-domain").text(),j[b].number=1)}),a.each(j,function(b,c){var d=localStorage.foldedGroups&&JSON.parse(localStorage.foldedGroups).indexOf(b)>-1;$wrapper=a("<div class='plansGroupWrapper"+(d?" folded":"")+"' data-object-id='"+b+"'></div>"),a("[plan_id][object_id='"+b+"']").prependTo(a(".plansGeneralWrapper")).wrapAll($wrapper),a(".plansGroupWrapper[data-object-id='"+b+"']").prepend("<div class='plansGroupWrapper-info'><div class='plansGroupWrapper-handle'></div><span><a href='/staff/sites/?site_id="+b+"'>Сайт #"+b+"</a></span><span class='domainName'><a href='http://"+c.domain+"'>"+c.domain+"</a></span><span>Количество планов: "+c.number+"</span><span class='plansGroupToggle'><a href='javascript:;'>Свернуть/развернуть</a></span></div>")}),k)for(var l=1;l<k.length;l++)a(".plansGroupWrapper[data-object-id='"+k[l]+"']").appendTo(".plansGeneralWrapper");a(".plansGroupToggle").on("click",function(){a(this).closest(".plansGroupWrapper").toggleClass("folded"),b()}),a(".plansGroupWrapper").customSortable(),a(".plansGeneralWrapper").sortable({items:".plansGroupWrapper",axis:"y",tolerance:"pointer",handle:".plansGroupWrapper-handle",stop:b})}else a(".plansGeneralWrapper").customSortable();if(localStorage.plansOrder)for(var m=JSON.parse(localStorage.plansOrder),l=0;l<m.length;l++)g.each(function(){a(this).attr("plan_id")==m[l]&&a(this).appendTo(a(this).parent())});if(localStorage.plansOpacity)for(var n=JSON.parse(localStorage.plansOpacity),l=0;l<n.length;l++)g.filter("[plan_id='"+n[l]+"']").css("opacity",h);b()}}(jQuery);