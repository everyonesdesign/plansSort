!function(a){function b(){c(),d(),e()}function c(){var b=[];a("[plan_id]").each(function(){var c=a(this).attr("plan_id");b.push(c)}),localStorage.plansOrder=JSON.stringify(b)}function d(){var b=[];f.each(function(){var c=a(this).attr("plan_id");1!=a(this).css("opacity")&&b.push(c)}),localStorage.plansOpacity=JSON.stringify(b)}function e(){if(h){var b=[];a(".plansGroupWrapper.folded").each(function(){var c=a(this).attr("data-object-id");b.push(c)}),localStorage.foldedGroups=JSON.stringify(b)}}if(a("#content").length){var f=a("[plan_id]"),g=.4,h=1==localStorage.groupPlans||!1;if(f.append("<div class='plan-icons'><div class='plan-icon plan-changeOpacity'></div><div class='plan-icon plan-moveHandle'></div></div>").wrapAll("<div class='plansGeneralWrapper'></div>"),a(".plan-changeOpacity").on("click",function(){var c=a(this).closest("[plan_id]");1==c.css("opacity")?c.css("opacity",g):c.css("opacity",1),b()}),a.fn.customSortable=function(){a(this).sortable({items:"[plan_id]",axis:"y",tolerance:"pointer",handle:".plan-moveHandle",stop:b})},a(".plansGeneralWrapper").before("<div class='plansGroupMode'><label><input id='plansSortToggle' type='checkbox'"+(h?" checked":"")+"> группировать по сайтам</label></div>"),a("#plansSortToggle").change(function(){localStorage.groupPlans=h?0:1,window.location.reload()}),h){var i={};f.each(function(){var b=a(this).attr("object_id");i[b]?i[b].number++:(i[b]={},i[b].domain=a(this).find(".site-domain").text(),i[b].number=1)}),a.each(i,function(b,c){var d=localStorage.foldedGroups&&JSON.parse(localStorage.foldedGroups).indexOf(b)>-1;$wrapper=a("<div class='plansGroupWrapper"+(d?" folded":"")+"' data-object-id='"+b+"'></div>"),a("[plan_id][object_id='"+b+"']").prependTo(a(".plansGeneralWrapper")).wrapAll($wrapper),a(".plansGroupWrapper[data-object-id='"+b+"']").prepend("<div class='plansGroupWrapper-info'><span><a href='/staff/sites/?site_id="+b+"'>Сайт #"+b+"</a></span><span class='domainName'><a href='http://"+c.domain+"'>"+c.domain+"</a></span><span>Количество планов: "+c.number+"</span><span class='plansGroupToggle'><a href='javascript:;'>Свернуть/развернуть</a></span></div>")}),a(".plansGroupToggle").on("click",function(){a(this).closest(".plansGroupWrapper").toggleClass("folded"),b()}),a(".plansGroupWrapper").customSortable()}else a(".plansGeneralWrapper").customSortable();if(localStorage.plansOrder)for(var j=JSON.parse(localStorage.plansOrder),k=0;k<j.length;k++)f.each(function(){a(this).attr("plan_id")==j[k]&&a(this).appendTo(a(this).parent())});if(localStorage.plansOpacity)for(var l=JSON.parse(localStorage.plansOpacity),k=0;k<l.length;k++)f.filter("[plan_id='"+l[k]+"']").css("opacity",g);b()}}(jQuery);