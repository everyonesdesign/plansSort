var plansManager={options:{hiddenOpacity:.4,defaultAllowedUrls:["/staff/client/plan.my.php"]},globals:{$plans:$("[plan_id]"),currentUrl:/(.*?)\/?$/.exec(window.location.pathname)[1]+window.location.search,currentLocation:" at "+/(.*?)\/?$/.exec(window.location.pathname)[1]+window.location.search,escapeRegExp:function(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}},markup:{plansControls:"<div class='plan-icons'><div class='plan-icon plan-changeOpacity'></div><div class='plan-icon plan-moveHandle'></div></div>",plansGeneralWrapper:"<div class='plansGeneralWrapper'></div>",plansTopPanelEnabled:"<div class='plansTopPanel'><input class='plansSearch' type='text' placeholder='Поиск по планам'><label><input class='plansGroupModeToggle' type='checkbox' %checked%> группировать по сайтам</label><button class='btn plansSortToggle plansSortToggle--disable'>Отключить сортировку</button></div>",plansTopPanelDisabled:"<div class='plansTopPanel'><input class='plansSearch' type='text' placeholder='Поиск по планам'><button class='btn btn-success plansSortToggle plansSortToggle--enable'>Включить сортировку</button></div>",plansGroupWrapper:"<div class='plansGroupWrapper %folded%' data-object-id='%key%'></div>",plansGroupWrapperInfo:"<div class='plansGroupWrapper-info'><div class='plansGroupWrapper-handle'></div><span><a href='/staff/sites/?site_id=%key%'>Сайт #%key%</a></span><span class='domainName'><a href='http://%domain%'>%domain%</a></span><span>Количество планов: %number%</span><span class='plansGroupToggle'><a href='javascript:;'>Свернуть/развернуть</a></span></div>"},init:function(){plansManager.globals.groupPlans=plansManager.read.groupsEnabled(),plansManager.setAllowedUrls(),plansManager.sync.startAutoSync(),plansManager.isUrlAllowed()?(plansManager.bootstrapAllowedUrl(),plansManager.bindPlansControls(),plansManager.bindGroupModeToggle(),plansManager.bindSortToggle(),plansManager.bindPlansSearch(),plansManager.globals.groupPlans?plansManager.initPlansGrouped():plansManager.initPlansUngrouped(),plansManager.sortPlans(),plansManager.setPlansOpacity()):(plansManager.bootstrapUnallowedUrl(),plansManager.bindSortToggle(),plansManager.bindPlansSearch())},bootstrapAllowedUrl:function(){var a=plansManager.globals.groupPlans?" checked":"";plansManager.globals.$plans.append(plansManager.markup.plansControls).wrapAll(plansManager.markup.plansGeneralWrapper),$(".plansGeneralWrapper").before(plansManager.markup.plansTopPanelEnabled.replace("%checked%",a))},bootstrapUnallowedUrl:function(){$(".attach_call_container").after(plansManager.markup.plansTopPanelDisabled)},setAllowedUrls:function(){plansManager.globals.allowedUrls=plansManager.read.allowedUrls()||plansManager.options.defaultAllowedUrls},isUrlAllowed:function(){return plansManager.globals.allowedUrls.indexOf(plansManager.globals.currentUrl)>-1},bindPlansControls:function(){$(".plan-changeOpacity").on("click",function(){var a=$(this).closest("[plan_id]");1==a.css("opacity")?a.css("opacity",plansManager.options.hiddenOpacity):a.css("opacity",1),plansManager.write.all()})},bindGroupModeToggle:function(){$(".plansGroupModeToggle").change(function(){plansManager.write.groupsEnabled(plansManager.globals.groupPlans?0:1),window.location.reload()})},bindGroupToggle:function(){$(".plansGroupToggle").on("click",function(){$(this).closest(".plansGroupWrapper").toggleClass("folded"),plansManager.write.all()})},bindSortToggle:function(){$(".plansSortToggle").on("click",function(){$(this).hasClass("plansSortToggle--enable")?plansManager.write.allowedUrls(plansManager.globals.currentUrl,"add"):plansManager.write.allowedUrls(plansManager.globals.currentUrl,"delete"),window.location.reload()})},bindPlansSearch:function(){$(".plansSearch").on("input",function(){var a=$(this),b=$("[plan_id]"),c=$.trim(a.val());$(".plansSearch-mark").each(function(){this.outerHTML=this.innerHTML}),c?($(document.body).addClass("body--plansSearch"),b.each(function(){var a=$(this),b=!1,d=a.find(".plan_body").add(a.find(".plan_comments")).add(a.find(".site-domain")).add(a.find(".site-domain").prev());d.each(function(){var d=$(this).text();d.toLowerCase().indexOf(c.toLowerCase())>-1&&($(this).highlightRegex(new RegExp(plansManager.globals.escapeRegExp(c),"gi"),{tagType:"mark",className:"plansSearch-mark"}),b=!0),a.toggleClass("matched",b)})})):($(document.body).removeClass("body--plansSearch"),b.removeClass("matched"))})},makeSortable:function(a){a.sortable({items:"[plan_id]",axis:"y",tolerance:"pointer",handle:".plan-moveHandle",stop:plansManager.write.all})},sortPlans:function(){if(plansManager.read.plansOrder())for(var a=plansManager.read.plansOrder(),b=0;b<a.length;b++)plansManager.globals.$plans.each(function(){$(this).attr("plan_id")==a[b]&&$(this).appendTo($(this).parent())})},setPlansOpacity:function(){if(plansManager.read.plansOpacity())for(var a=plansManager.read.plansOpacity(),b=0;b<a.length;b++)plansManager.globals.$plans.filter("[plan_id='"+a[b]+"']").css("opacity",plansManager.options.hiddenOpacity)},initPlansGrouped:function(){var a={},b=plansManager.read.groupsOrder();if(plansManager.globals.$plans.each(function(){var b=$(this).attr("object_id");a[b]?a[b].number++:(a[b]={},a[b].domain=$(this).find(".site-domain").text(),a[b].number=1)}),$.each(a,function(a,b){var c,d=plansManager.read.groupsFolded()&&plansManager.read.groupsFolded().indexOf(a)>-1,e=d?" folded":"",f=$("[plan_id][object_id='"+a+"']");c=$(plansManager.markup.plansGroupWrapper.replace("%folded%",e).replace("%key%",a)),f.prependTo($(".plansGeneralWrapper")),f.wrapAll(c),$(".plansGroupWrapper[data-object-id='"+a+"']").prepend(plansManager.markup.plansGroupWrapperInfo.replace(/%key%/g,a).replace(/%domain%/g,b.domain).replace(/%number%/g,b.number))}),b)for(var c=0;c<b.length;c++)$(".plansGroupWrapper[data-object-id='"+b[c]+"']").appendTo(".plansGeneralWrapper");plansManager.bindGroupToggle(),plansManager.makeSortable($(".plansGroupWrapper")),$(".plansGeneralWrapper").sortable({items:".plansGroupWrapper",axis:"y",tolerance:"pointer",handle:".plansGroupWrapper-handle",stop:plansManager.write.all})},initPlansUngrouped:function(){plansManager.makeSortable($(".plansGeneralWrapper"))},read:{plansOrder:function(){return localStorage["plansOrder"+plansManager.globals.currentLocation]?JSON.parse(localStorage["plansOrder"+plansManager.globals.currentLocation]):!1},timestamp:function(){return+localStorage.plansOrderTimestamp},plansOpacity:function(){return localStorage["plansOpacity"+plansManager.globals.currentLocation]?JSON.parse(localStorage["plansOpacity"+plansManager.globals.currentLocation]):!1},groupsEnabled:function(){return 1==localStorage["groupPlans"+plansManager.globals.currentLocation]},groupsOrder:function(){return localStorage["groupsOrder"+plansManager.globals.currentLocation]?JSON.parse(localStorage["groupsOrder"+plansManager.globals.currentLocation]):!1},groupsFolded:function(){return localStorage["foldedGroups"+plansManager.globals.currentLocation]?JSON.parse(localStorage["foldedGroups"+plansManager.globals.currentLocation]):!1},allowedUrls:function(){return localStorage.allowedUrls?JSON.parse(localStorage.allowedUrls):!1}},write:{all:function(){plansManager.write.plansOrder(),plansManager.write.plansOpacity(),plansManager.write.groupsOrder(),plansManager.write.groupsFolded()},timestamp:function(){localStorage.plansOrderTimestamp=+new Date},plansOrder:function(){var a=[];$("[plan_id]").each(function(){var b=$(this).attr("plan_id");a.push(b)}),localStorage["plansOrder"+plansManager.globals.currentLocation]=JSON.stringify(a),plansManager.write.timestamp()},plansOpacity:function(){var a=[];$("[plan_id]").each(function(){var b=$(this).attr("plan_id");1!=$(this).css("opacity")&&a.push(b)}),localStorage["plansOpacity"+plansManager.globals.currentLocation]=JSON.stringify(a),plansManager.write.timestamp()},groupsOrder:function(){var a=[];plansManager.globals.groupPlans&&($(".plansGroupWrapper").each(function(){var b=$(this).attr("data-object-id");a.push(b)}),localStorage["groupsOrder"+plansManager.globals.currentLocation]=JSON.stringify(a),plansManager.write.timestamp())},groupsFolded:function(){if(plansManager.globals.groupPlans){var a=[];$(".plansGroupWrapper.folded").each(function(){var b=$(this).attr("data-object-id");a.push(b)}),localStorage["foldedGroups"+plansManager.globals.currentLocation]=JSON.stringify(a),plansManager.write.timestamp()}},groupsEnabled:function(a){localStorage["groupPlans"+plansManager.globals.currentLocation]=a,plansManager.write.timestamp()},allowedUrls:function(a,b){var c;"add"===b?(plansManager.globals.allowedUrls.push(a),c=plansManager.globals.allowedUrls):"delete"===b&&(c=$.map(plansManager.globals.allowedUrls,function(b){return b===a?null:b})),localStorage.allowedUrls=JSON.stringify(c),plansManager.write.timestamp()}},sync:{pull:function(){chrome.storage.sync.get(null,function(a){plansManager.sync.clearLocal();for(var b=0;b<a.length;b++)localStorage[b.name]=b.value;plansManager.write.timestamp()})},push:function(){var a={};chrome.storage.sync.clear(),plansManager.write.timestamp(),$.each(localStorage,function(b,c){a[b]=c}),chrome.storage.sync.set(a)},clearLocal:function(){for(var a=0;a<localStorage.length;a++)localStorage.removeItem(localStorage.key(a))},sync:function(a){chrome.storage.sync.get("plansOrderTimestamp",function(b){b.plansOrderTimestamp&&(b.plansOrderTimestamp>plansManager.read.timestamp()||!plansManager.read.timestamp())?plansManager.sync.pull():plansManager.sync.push(),a()})},startAutoSync:function(){setInterval(plansManager.sync.sync,6e5)}}};$("#content").length&&plansManager.globals.$plans.length&&plansManager.sync.sync(plansManager.init);