var plansSort={options:{hiddenOpacity:.4,defaultAllowedUrls:["/staff/client/plan.my.php"]},globals:{$plans:$("[plan_id]"),currentUrl:/(.*?)\/?$/.exec(window.location.pathname)[1]+window.location.search,currentLocation:" at "+/(.*?)\/?$/.exec(window.location.pathname)[1]+window.location.search},markup:{plansControls:"<div class='plan-icons'><div class='plan-icon plan-changeOpacity'></div><div class='plan-icon plan-moveHandle'></div></div>",plansGeneralWrapper:"<div class='plansGeneralWrapper'></div>",plansTopPanelEnabled:"<div class='plansTopPanel'><label><input class='plansGroupModeToggle' type='checkbox' %checked%> группировать по сайтам</label><button class='btn plansSortToggle plansSortToggle--disable'>Отключить сортировку</button></div>",plansTopPanelDisabled:"<div class='plansTopPanel'><button class='btn btn-success plansSortToggle plansSortToggle--enable'>Включить сортировку</button></div>",plansGroupWrapper:"<div class='plansGroupWrapper %folded%' data-object-id='%key%'></div>",plansGroupWrapperInfo:"<div class='plansGroupWrapper-info'><div class='plansGroupWrapper-handle'></div><span><a href='/staff/sites/?site_id=%key%'>Сайт #%key%</a></span><span class='domainName'><a href='http://%domain%'>%domain%</a></span><span>Количество планов: %number%</span><span class='plansGroupToggle'><a href='javascript:;'>Свернуть/развернуть</a></span></div>"},init:function(){plansSort.globals.groupPlans=plansSort.read.groupsEnabled(),plansSort.setAllowedUrls(),plansSort.isUrlAllowed()?(plansSort.bootstrapAllowedUrl(),plansSort.bindPlansControls(),plansSort.bindGroupModeToggle(),plansSort.bindSortToggle(),plansSort.globals.groupPlans?plansSort.initPlansGrouped():plansSort.initPlansUngrouped(),plansSort.sortPlans(),plansSort.setPlansOpacity()):(plansSort.bootstrapUnallowedUrl(),plansSort.bindSortToggle())},bootstrapAllowedUrl:function(){var a=plansSort.globals.groupPlans?" checked":"";plansSort.globals.$plans.append(plansSort.markup.plansControls).wrapAll(plansSort.markup.plansGeneralWrapper),$(".plansGeneralWrapper").before(plansSort.markup.plansTopPanelEnabled.replace("%checked%",a))},bootstrapUnallowedUrl:function(){$(".attach_call_container").after(plansSort.markup.plansTopPanelDisabled)},setAllowedUrls:function(){plansSort.globals.allowedUrls=plansSort.read.allowedUrls()||plansSort.options.defaultAllowedUrls},isUrlAllowed:function(){return plansSort.globals.allowedUrls.indexOf(plansSort.globals.currentUrl)>-1},bindPlansControls:function(){$(".plan-changeOpacity").on("click",function(){var a=$(this).closest("[plan_id]");1==a.css("opacity")?a.css("opacity",plansSort.options.hiddenOpacity):a.css("opacity",1),plansSort.write.all()})},bindGroupModeToggle:function(){$(".plansGroupModeToggle").change(function(){plansSort.write.groupsEnabled(plansSort.globals.groupPlans?0:1),window.location.reload()})},bindGroupToggle:function(){$(".plansGroupToggle").on("click",function(){$(this).closest(".plansGroupWrapper").toggleClass("folded"),plansSort.write.all()})},bindSortToggle:function(){$(".plansSortToggle").click(function(){$(this).hasClass("plansSortToggle--enable")?plansSort.write.allowedUrls(plansSort.globals.currentUrl,"add"):plansSort.write.allowedUrls(plansSort.globals.currentUrl,"delete"),window.location.reload()})},makeSortable:function(a){a.sortable({items:"[plan_id]",axis:"y",tolerance:"pointer",handle:".plan-moveHandle",stop:plansSort.write.all})},sortPlans:function(){if(plansSort.read.plansOrder())for(var a=plansSort.read.plansOrder(),b=0;b<a.length;b++)plansSort.globals.$plans.each(function(){$(this).attr("plan_id")==a[b]&&$(this).appendTo($(this).parent())})},setPlansOpacity:function(){if(plansSort.read.plansOpacity())for(var a=plansSort.read.plansOpacity(),b=0;b<a.length;b++)plansSort.globals.$plans.filter("[plan_id='"+a[b]+"']").css("opacity",plansSort.options.hiddenOpacity)},initPlansGrouped:function(){var a={},b=plansSort.read.groupsOrder();if(plansSort.globals.$plans.each(function(){var b=$(this).attr("object_id");a[b]?a[b].number++:(a[b]={},a[b].domain=$(this).find(".site-domain").text(),a[b].number=1)}),$.each(a,function(a,b){var c,d=plansSort.read.groupsFolded()&&plansSort.read.groupsFolded().indexOf(a)>-1,e=d?" folded":"",f=$("[plan_id][object_id='"+a+"']");c=$(plansSort.markup.plansGroupWrapper.replace("%folded%",e).replace("%key%",a)),f.prependTo($(".plansGeneralWrapper")),f.wrapAll(c),$(".plansGroupWrapper[data-object-id='"+a+"']").prepend(plansSort.markup.plansGroupWrapperInfo.replace(/%key%/g,a).replace(/%domain%/g,b.domain).replace(/%number%/g,b.number))}),b)for(var c=0;c<b.length;c++)$(".plansGroupWrapper[data-object-id='"+b[c]+"']").appendTo(".plansGeneralWrapper");plansSort.bindGroupToggle(),plansSort.makeSortable($(".plansGroupWrapper")),$(".plansGeneralWrapper").sortable({items:".plansGroupWrapper",axis:"y",tolerance:"pointer",handle:".plansGroupWrapper-handle",stop:plansSort.write.all})},initPlansUngrouped:function(){plansSort.makeSortable($(".plansGeneralWrapper"))},read:{plansOrder:function(){return localStorage["plansOrder"+plansSort.globals.currentLocation]?JSON.parse(localStorage["plansOrder"+plansSort.globals.currentLocation]):!1},plansOpacity:function(){return localStorage["plansOpacity"+plansSort.globals.currentLocation]?JSON.parse(localStorage["plansOpacity"+plansSort.globals.currentLocation]):!1},groupsEnabled:function(){return 1==localStorage["groupPlans"+plansSort.globals.currentLocation]},groupsOrder:function(){return localStorage["groupsOrder"+plansSort.globals.currentLocation]?JSON.parse(localStorage["groupsOrder"+plansSort.globals.currentLocation]):!1},groupsFolded:function(){return localStorage["foldedGroups"+plansSort.globals.currentLocation]?JSON.parse(localStorage["foldedGroups"+plansSort.globals.currentLocation]):!1},allowedUrls:function(){return localStorage.allowedUrls?JSON.parse(localStorage.allowedUrls):!1}},write:{all:function(){plansSort.write.plansOrder(),plansSort.write.plansOpacity(),plansSort.write.groupsOrder(),plansSort.write.groupsFolded()},plansOrder:function(){var a=[];$("[plan_id]").each(function(){var b=$(this).attr("plan_id");a.push(b)}),localStorage["plansOrder"+plansSort.globals.currentLocation]=JSON.stringify(a)},plansOpacity:function(){var a=[];$("[plan_id]").each(function(){var b=$(this).attr("plan_id");1!=$(this).css("opacity")&&a.push(b)}),localStorage["plansOpacity"+plansSort.globals.currentLocation]=JSON.stringify(a)},groupsOrder:function(){var a=[];plansSort.globals.groupPlans&&($(".plansGroupWrapper").each(function(){var b=$(this).attr("data-object-id");a.push(b)}),localStorage["groupsOrder"+plansSort.globals.currentLocation]=JSON.stringify(a))},groupsFolded:function(){if(plansSort.globals.groupPlans){var a=[];$(".plansGroupWrapper.folded").each(function(){var b=$(this).attr("data-object-id");a.push(b)}),localStorage["foldedGroups"+plansSort.globals.currentLocation]=JSON.stringify(a)}},groupsEnabled:function(a){localStorage["groupPlans"+plansSort.globals.currentLocation]=a},allowedUrls:function(a,b){var c;"add"===b?(plansSort.globals.allowedUrls.push(a),c=plansSort.globals.allowedUrls):"delete"===b&&(c=$.map(plansSort.globals.allowedUrls,function(b){return b===a?null:b})),localStorage.allowedUrls=JSON.stringify(c)}}};$("#content").length&&plansSort.globals.$plans.length&&plansSort.init();