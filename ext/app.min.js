var plansManager={options:{hiddenOpacity:.4,defaultAllowedUrls:["/staff/client/plan.my.php"]},globals:{$plans:$("[plan_id]"),currentUrl:/(.*?)\/?$/.exec(window.location.pathname)[1]+window.location.search,currentLocation:" at "+/(.*?)\/?$/.exec(window.location.pathname)[1]+window.location.search,escapeRegExp:function(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}},markup:{plansControls:"<div class='plan-icons'><div class='plan-icon plan-changeOpacity'></div><div class='plan-icon plan-moveHandle'></div></div>",plansGeneralWrapper:"<div class='plansGeneralWrapper'></div>",plansTopPanelEnabled:"<div class='plansTopPanel'><input class='plansSearch' type='text' placeholder='Поиск по планам'><label><input class='plansGroupModeToggle' type='checkbox' %checked%> группировать по сайтам</label><button class='btn plansSortToggle plansSortToggle--disable'>Отключить сортировку</button></div>",plansTopPanelDisabled:"<div class='plansTopPanel'><input class='plansSearch' type='text' placeholder='Поиск по планам'><button class='btn btn-success plansSortToggle plansSortToggle--enable'>Включить сортировку</button></div>",plansGroupWrapper:"<div class='plansGroupWrapper %folded%' data-object-id='%key%'></div>",plansGroupWrapperInfo:"<div class='plansGroupWrapper-info'><div class='plansGroupWrapper-handle'></div><span><a href='/staff/sites/?site_id=%key%'>Сайт #%key%</a></span><span class='domainName'><a href='http://%domain%'>%domain%</a></span><span>Количество планов: %number%</span><span class='plansGroupToggle'><a href='javascript:;'>Свернуть/развернуть</a></span></div>"},init:function(){plansManager.read.groupsEnabled(function(a){plansManager.globals.groupPlans=a,plansManager.setAllowedUrls(function(){plansManager.sync.startAutoSync(),plansManager.isUrlAllowed()?(plansManager.bootstrapAllowedUrl(),plansManager.bindPlansControls(),plansManager.bindGroupModeToggle(),plansManager.bindSortToggle(),plansManager.bindPlansSearch(),plansManager.globals.groupPlans?plansManager.initPlansGrouped():plansManager.initPlansUngrouped(),plansManager.sortPlans(),plansManager.setPlansOpacity()):(plansManager.bootstrapUnallowedUrl(),plansManager.bindSortToggle(),plansManager.bindPlansSearch())})})},bootstrapAllowedUrl:function(){var a=plansManager.globals.groupPlans?" checked":"";plansManager.globals.$plans.append(plansManager.markup.plansControls).wrapAll(plansManager.markup.plansGeneralWrapper),$(".plansGeneralWrapper").before(plansManager.markup.plansTopPanelEnabled.replace("%checked%",a))},bootstrapUnallowedUrl:function(){$(".attach_call_container").after(plansManager.markup.plansTopPanelDisabled)},setAllowedUrls:function(a){plansManager.read.allowedUrls(function(b){plansManager.globals.allowedUrls=b||plansManager.options.defaultAllowedUrls,a()})},isUrlAllowed:function(){return plansManager.globals.allowedUrls.indexOf(plansManager.globals.currentUrl)>-1},bindPlansControls:function(){$(".plan-changeOpacity").on("click",function(){var a=$(this).closest("[plan_id]");1==a.css("opacity")?a.css("opacity",plansManager.options.hiddenOpacity):a.css("opacity",1),plansManager.write.all()})},bindGroupModeToggle:function(){$(".plansGroupModeToggle").change(function(){plansManager.write.groupsEnabled(plansManager.globals.groupPlans?0:1),window.location.reload()})},bindGroupToggle:function(){$(".plansGroupToggle").on("click",function(){$(this).closest(".plansGroupWrapper").toggleClass("folded"),plansManager.write.all()})},bindSortToggle:function(){$(".plansSortToggle").on("click",function(){$(this).hasClass("plansSortToggle--enable")?plansManager.write.allowedUrls(plansManager.globals.currentUrl,"add"):plansManager.write.allowedUrls(plansManager.globals.currentUrl,"delete"),window.location.reload()})},bindPlansSearch:function(){$(".plansSearch").on("input",function(){var a=$(this),b=$("[plan_id]"),c=$.trim(a.val());$(".plansSearch-mark").each(function(){this.outerHTML=this.innerHTML}),c?($(document.body).addClass("body--plansSearch"),b.each(function(){var a=$(this),b=!1,d=a.find(".plan_body").add(a.find(".plan_comments")).add(a.find(".site-domain")).add(a.find(".site-domain").prev());d.each(function(){var d=$(this).text();d.toLowerCase().indexOf(c.toLowerCase())>-1&&($(this).highlightRegex(new RegExp(plansManager.globals.escapeRegExp(c),"gi"),{tagType:"mark",className:"plansSearch-mark"}),b=!0),a.toggleClass("matched",b)})})):($(document.body).removeClass("body--plansSearch"),b.removeClass("matched"))})},makeSortable:function(a){a.sortable({items:"[plan_id]",axis:"y",tolerance:"pointer",handle:".plan-moveHandle",stop:plansManager.write.all})},sortPlans:function(){plansManager.read.plansOrder(function(a){if(a)for(var b=0;b<a.length;b++)plansManager.globals.$plans.each(function(){$(this).attr("plan_id")==a[b]&&$(this).appendTo($(this).parent())})})},setPlansOpacity:function(){plansManager.read.plansOpacity(function(a){if(a)for(var b=0;b<a.length;b++)plansManager.globals.$plans.filter("[plan_id='"+a[b]+"']").css("opacity",plansManager.options.hiddenOpacity)})},initPlansGrouped:function(){var a={};plansManager.read.groupsOrder(function(b){plansManager.read.groupsFolded(function(c){if(plansManager.globals.$plans.each(function(){var b=$(this).attr("object_id");a[b]?a[b].number++:(a[b]={},a[b].domain=$(this).find(".site-domain").text(),a[b].number=1)}),$.each(a,function(a,b){var d,e=c&&c.indexOf(a)>-1,f=e?" folded":"",g=$("[plan_id][object_id='"+a+"']");d=$(plansManager.markup.plansGroupWrapper.replace("%folded%",f).replace("%key%",a)),g.prependTo($(".plansGeneralWrapper")),g.wrapAll(d),$(".plansGroupWrapper[data-object-id='"+a+"']").prepend(plansManager.markup.plansGroupWrapperInfo.replace(/%key%/g,a).replace(/%domain%/g,b.domain).replace(/%number%/g,b.number))}),b)for(var d=0;d<b.length;d++)$(".plansGroupWrapper[data-object-id='"+b[d]+"']").appendTo(".plansGeneralWrapper");plansManager.bindGroupToggle(),plansManager.makeSortable($(".plansGroupWrapper")),$(".plansGeneralWrapper").sortable({items:".plansGroupWrapper",axis:"y",tolerance:"pointer",handle:".plansGroupWrapper-handle",stop:plansManager.write.all})})})},initPlansUngrouped:function(){plansManager.makeSortable($(".plansGeneralWrapper"))},read:{plansOrder:function(a){chrome.storage.local.get("plansOrder"+plansManager.globals.currentLocation,function(b){a(b["plansOrder"+plansManager.globals.currentLocation]?JSON.parse(b["plansOrder"+plansManager.globals.currentLocation]):!1)})},timestamp:function(a){chrome.storage.local.get("plansOrderTimestamp",function(b){a(+b.plansOrderTimestamp||!1)})},plansOpacity:function(a){chrome.storage.local.get(["plansOpacity"+plansManager.globals.currentLocation],function(b){a(b["plansOpacity"+plansManager.globals.currentLocation]?JSON.parse(b["plansOpacity"+plansManager.globals.currentLocation]):!1)})},groupsEnabled:function(a){chrome.storage.local.get("groupPlans"+plansManager.globals.currentLocation,function(b){a(!!b["groupPlans"+plansManager.globals.currentLocation])})},groupsOrder:function(a){chrome.storage.local.get("groupsOrder"+plansManager.globals.currentLocation,function(b){a(b["groupsOrder"+plansManager.globals.currentLocation]?JSON.parse(b["groupsOrder"+plansManager.globals.currentLocation]):!1)})},groupsFolded:function(a){chrome.storage.local.get("foldedGroups"+plansManager.globals.currentLocation,function(b){a(b["foldedGroups"+plansManager.globals.currentLocation]?JSON.parse(b["foldedGroups"+plansManager.globals.currentLocation]):[])})},allowedUrls:function(a){chrome.storage.local.get("allowedUrls",function(b){a(b.allowedUrls?JSON.parse(b.allowedUrls):!1)})}},write:{all:function(){plansManager.write.plansOrder(),plansManager.write.plansOpacity(),plansManager.write.groupsOrder(),plansManager.write.groupsFolded()},timestamp:function(){chrome.storage.local.set({plansOrderTimestamp:+new Date})},plansOrder:function(){var a=[],b={};$("[plan_id]").each(function(){var b=$(this).attr("plan_id");a.push(b)}),b["plansOrder"+plansManager.globals.currentLocation]=JSON.stringify(a),chrome.storage.local.set(b),plansManager.write.timestamp()},plansOpacity:function(){var a=[],b={};$("[plan_id]").each(function(){var b=$(this).attr("plan_id");1!=$(this).css("opacity")&&a.push(b)}),b["plansOpacity"+plansManager.globals.currentLocation]=JSON.stringify(a),chrome.storage.local.set(b),plansManager.write.timestamp()},groupsOrder:function(){var a=[],b={};plansManager.globals.groupPlans&&($(".plansGroupWrapper").each(function(){var b=$(this).attr("data-object-id");a.push(b)}),b["groupsOrder"+plansManager.globals.currentLocation]=JSON.stringify(a),chrome.storage.local.set(b),plansManager.write.timestamp())},groupsFolded:function(){var a=[],b={};plansManager.globals.groupPlans&&($(".plansGroupWrapper.folded").each(function(){var b=$(this).attr("data-object-id");a.push(b)}),b["foldedGroups"+plansManager.globals.currentLocation]=JSON.stringify(a),chrome.storage.local.set(b),plansManager.write.timestamp())},groupsEnabled:function(a){var b={};b["groupPlans"+plansManager.globals.currentLocation]=a,chrome.storage.local.set(b),plansManager.write.timestamp()},allowedUrls:function(a,b){var c;"add"===b?(plansManager.globals.allowedUrls.push(a),c=plansManager.globals.allowedUrls):"delete"===b&&(c=$.map(plansManager.globals.allowedUrls,function(b){return b===a?null:b})),chrome.storage.local.set({allowedUrls:JSON.stringify(c)}),plansManager.write.timestamp()}},sync:{pull:function(a){var b={};a=a||function(){},chrome.storage.local.clear(),chrome.storage.sync.get(null,function(c){$.each(c,function(a,c){b[a]=c}),chrome.storage.local.set(b),plansManager.write.timestamp(),a()})},push:function(a){var b={};a=a||function(){},chrome.storage.sync.clear(),plansManager.write.timestamp(),chrome.storage.local.get(null,function(c){$.each(c,function(a,c){b[a]=c}),chrome.storage.sync.set(b),a()})},sync:function(a){chrome.storage.sync.get("plansOrderTimestamp",function(b){plansManager.read.timestamp(function(c){b.plansOrderTimestamp&&(b.plansOrderTimestamp>c||!c)&&window.confirm("PlansManager: На другом компьютере обнаружены более новые параметры сортировки. Синхронизировать?")?plansManager.sync.pull(function(){window.location.reload()}):plansManager.sync.push(a)})})},startAutoSync:function(){setInterval(plansManager.sync.sync,6e5)}}};$("#content").length&&plansManager.globals.$plans.length&&plansManager.init(),$(document.body).on("click",function(){chrome.storage.local.get(null,function(a){console.dir(a)})});